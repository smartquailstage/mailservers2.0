#############################
# Autenticación y depuración
#############################
auth_mechanisms = plain login
auth_verbose = yes
auth_debug = yes
auth_debug_passwords = yes

##########################
# Servicio de autenticación
##########################
service auth {
  client_limit = 2000

  # Listener TCP para autenticación SASL desde Postfix
  inet_listener auth {
    port = 12345  # Debe coincidir con el puerto usado en Postfix (SASL_TCP_PORT)
    # Puedes agregar "address = 127.0.0.1" si solo debe escuchar en localhost
    # Puedes agregar ssl = yes si deseas asegurar esta conexión
  }

  # Listener interno usado por otros servicios de Dovecot (no eliminar)
  unix_listener auth-userdb {
    mode = 0660
    user = dovecot
    group = dovecot
  }
}

##########################
# Servicio LMTP (por TCP)
##########################
service lmtp {
  # Eliminamos el socket UNIX ya que Postfix y Dovecot están en distintos pods
  # unix_listener /var/spool/postfix/private/dovecot-lmtp {
  #   user  = postfix
  #   group = postfix
  #   mode  = 0660
  # }

  # Listener TCP para LMTP (usado por Postfix para entrega de correo)
  inet_listener lmtp {
    port = 24  # Puedes ajustar el puerto si necesitas
  }
}

##########################
# Servicios IMAP/IMAPS
##########################
service imap-login {
  inet_listener imap {
    port = 143
  }
  inet_listener imaps {
    port = 993
    ssl = yes
  }
}

##########################
# Servicios POP3/POP3S
##########################
service pop3-login {
  inet_listener pop3 {
    port = 0  # Desactivado
  }
  inet_listener pop3s {
    port = 995
    ssl = yes
  }
}

##########################
# Servicio Submission
##########################
service submission-login {
  inet_listener submission {
    port = 587
    ssl = yes
  }
  process_min_avail = 1
  client_limit = 1000
  service_count = 0
}

##########################
# Servicio ManageSieve
##########################
service managesieve-login {
  process_min_avail = 1
  client_limit = 1000
  service_count = 0
}

##########################
# Worker de autenticación
##########################
service auth-worker {
  user = dovecot
}

##########################
# Grupo privilegiado
##########################
mail_privileged_group = mail

##########################
# Autenticación SQL
##########################
!include auth-sql.conf.ext
